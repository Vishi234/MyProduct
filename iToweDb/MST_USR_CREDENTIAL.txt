
  CREATE TABLE "ITOWER"."MST_USER_CREDENTIALS" 
   (	"USER_ID" NUMBER(10,0), 
	"LOGIN_ID" VARCHAR2(100 BYTE) NOT NULL ENABLE, 
	"PASSWORD" VARCHAR2(100 BYTE) NOT NULL ENABLE, 
	"PASS_RESET_DATE" DATE, 
	"LAST_LOGIN_TIME" DATE, 
	"CREATED_BY" VARCHAR2(100 BYTE), 
	"CREATED_DATE" DATE DEFAULT SYSDATE, 
	"LAST_MODIFIED_BY" VARCHAR2(100 BYTE), 
	"LAST_MODIFIED_DATE" DATE, 
	"DEVICE_ID" VARCHAR2(1000 BYTE), 
	"IMEI_NO" VARCHAR2(100 BYTE), 
	"ACCOUNT_LOCKED" CHAR(1 BYTE) DEFAULT 'N', 
	"LAST_EXPIRE_INFO_DT" DATE, 
	"LOGIN_STATE" VARCHAR2(1 BYTE), 
	"IP_ADDRESS" VARCHAR2(50 BYTE), 
	"ACTIVE_USER" NUMBER(1,0), 
	"LAST_USER_ACT_TIME" DATE, 
	 CONSTRAINT "PK_MST_USER_CREDENTIALS" PRIMARY KEY ("USER_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "ETS_INDEX"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "ETS_DATA" ;
 

  CREATE OR REPLACE TRIGGER "ITOWER"."TRG_MST_USER_CREDENTIALS_AFR" 
AFTER INSERT OR UPDATE ON  MST_USER_CREDENTIALS FOR EACH ROW

/*******************************************************************************************************
Created BY - Manoj Yadav on 15th April, 2013
Purpose - This Trigger is used to insert the user personal setting into MST2_SYSTEM_PARAM when new user id added

Modified By : Karishma Mithal on 18 NOV 2016
Purpose     : To maintain history of password change.
Version     : 0.1

Modified By : Manoj Yadav on 22nd Jan, 2018
Purpose     : To insert in TXN_DATA_UPDATE_STATUS table in case any data updated/inserted/deleted.
Version     : 0.2

Modified By : Samrat
Purpose     : To insert in TXN_MAIL_DETAIL table in case user updated password.
Version     : 0.3

Modified By : Sunil
Purpose     : Add seprator in in seprator column while changing password.
Version     : 0.4
*********************************************************************************************************/

DECLARE
V_FIRST_NAME VARCHAR2(250);--0.3
V_DETAIL     VARCHAR2(250); --0.3
C_SEND_MAIL  VARCHAR2(1) := PKG_IROC_CONFIG_DATA.SEND_MAIL;
V_SENDER_MAIL_ID VARCHAR2(250);

BEGIN

    IF INSERTING THEN

        INSERT INTO MST2_SYSTEM_PARAM(ID,TYPE,TYPE_ID,PARAM_DISPLAY_FLAG,PARAM_TYPE,PARAM_VALUE,WEF_DATE,WET_DATE,CREATED_DATE,CREATED_BY)
        SELECT ID,6,:NEW.USER_ID,PARAM_DISPLAY_FLAG,PARAM_TYPE,PARAM_VALUE,TRUNC(SYSDATE),NULL,SYSDATE,'Admin'
        FROM MST2_SYSTEM_PARAM MSP
        WHERE TYPE_ID = 0;

        --0.2
        INSERT INTO TXN_DATA_UPDATE_STATUS(DATA_TYPE_ID,CREATED_BY,CREATED_DATE) VALUES(300,'TRG_MST_USER_CREDENTIALS_AFR',SYSDATE); -- Syncup data in MST_PEOPLE_DETAIL

    ELSE --0.1
        IF :NEW.PASSWORD <> :OLD.PASSWORD THEN



            INSERT INTO TXN_PASSWORD_HISTORY ( USER_ID, OLD_PASSWORD, CREATED_BY, CREATED_DATE )
            VALUES (:NEW.USER_ID, :OLD.PASSWORD, :NEW.LOGIN_ID, SYSDATE);

            IF C_SEND_MAIL ='Y' THEN --0.3

--            DELETE DEBUG_SQL;
--            INSERT INTO DEBUG_SQL VALUES(:OLD.USER_ID);

                SELECT LISTAGG(DETAIL, ',') WITHIN GROUP (ORDER BY NULL) ,MAX(distinct MU.FIRST_NAME) INTO V_DETAIL,V_FIRST_NAME
                 FROM MST_CONTACT_DETAIL_HIS MCD,MST_USER MU WHERE CONTACT_TYPE IN(1)
                 AND MCD.USER_ID = MU.USER_ID
                 AND MCD.USER_ID=:OLD.USER_ID
                  AND TRUNC(SYSDATE) BETWEEN MCD.WEF_DATE AND NVL(MCD.WET_DATE,TRUNC(SYSDATE))
                  AND TRUNC(SYSDATE) BETWEEN MU.WEF_DATE AND NVL(MU.WET_DATE,TRUNC(SYSDATE));--0.3

                 SELECT SENDER_MAIL_ID INTO V_SENDER_MAIL_ID FROM Mst_Mail_Config WHERE ID=25;

                INSERT INTO TXN_MAIL_DETAIL(ID,MAIL_TEMPLATE_ID,TO_MAILID_LIST,MAIL_DATA,DATA_SEPERATOR,STATUS,CREATED_DATE,CREATED_BY) --0.3--0.4
                VALUES(1,25,V_DETAIL,'user_name='||V_FIRST_NAME ||'~'||'support_mail='||V_SENDER_MAIL_ID,'~',1,SYSDATE,'TRG_MST_USER_CREDENTIALS_AFR');

            END IF;

        END IF;
    END IF;
END;
/
ALTER TRIGGER "ITOWER"."TRG_MST_USER_CREDENTIALS_AFR" ENABLE;
 
